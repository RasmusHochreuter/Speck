# Feature: Team Member Invite
> Specification generated by /plan-feature on 2026-02-13
> âš ï¸ This is a planning document. No implementation code has been written.
> **Complexity: Medium** â€” external integration (email), role hierarchy, token expiry, multiple decision branches.

## Implementation Instructions
This specification is context for the implementing agent. Read and internalize it fully before writing any code.

**IMPORTANT â€” Do NOT:**
- Add comments referencing this spec (no `// See spec: ...`, no `// Don't #3`)
- Structure code around spec sections â€” structure it around clean domain logic
- Embed spec traceability IDs in code, comments, variable names, or test names
- Add comments explaining "why" when the code is self-documenting

**DO:**
- Write clean, idiomatic C# that follows the reference implementation patterns
- Let the constraints from this spec guide your decisions silently â€” they should be invisible in the final code
- Name things after domain concepts, not spec concepts
- Write tests that verify behavior, named after what they verify (not after spec requirement IDs)

## Overview
Workspace admins and owners can invite new members by email address with a specified role. The system sends an invitation email with a unique token link. Recipients can accept or decline. Invitations expire after 7 days and can be resent or revoked.

## Scope
### In Scope
- Send invite by email with role assignment (Member, Admin)
- Invite token generation with 7-day expiry
- Accept invite (creates workspace membership or links existing user)
- Decline invite (soft-marks as declined)
- Resend invite (resets token and expiry)
- Revoke pending invite
- List pending invites for a workspace

### Out of Scope
- Bulk invite (CSV upload or multi-email)
- Invite via shareable link (no token-per-user)
- SSO/SAML auto-provisioning
- Workspace creation (already exists)
- Role management beyond invite (changing roles post-join is a separate feature)

### Deferred
- Invite analytics (acceptance rate, time-to-accept)
- Custom invite email templates per workspace
- Invite approval workflow (e.g., Owner must approve Admin invites from other Admins)

## Reference Implementation
- Reference: `src/Features/Workspaces/AddWorkspace/AddWorkspaceHandler.cs`
- Follow the same: MediatR command/handler, FluentValidation, repository + domain event pattern
- Also reference: `src/Features/Auth/ResetPassword/ResetPasswordHandler.cs` for token generation and expiry pattern

## Codebase Context
- Architecture: Vertical Slices within Clean Architecture
- ORM: EF Core 8 with repository pattern (`IWorkspaceRepository`, `IUserRepository`)
- Mediator: MediatR
- Test framework: xUnit + NSubstitute + FluentAssertions
- Validation: FluentValidation
- DI registration: Via `AddWorkspaceModule()` extension
- Error handling: `Result<T>` pattern
- Email: `IEmailService` â€” async, fire-and-forget via domain events. Uses `src/Infrastructure/Email/EmailService.cs`
- Token generation: `ITokenService` â€” see `src/Infrastructure/Security/TokenService.cs` for the pattern used in password reset

## Requirements
- Workspace Owners and Admins can invite new members by email
- Invitations include a role (Member or Admin) that applies when accepted
- A unique, cryptographically secure token is generated per invite with a 7-day expiry
- An email is sent with a link containing the token
- The recipient can accept (joins workspace) or decline
- If the email belongs to an existing user, acceptance links them to the workspace
- If the email doesn't belong to an existing user, acceptance redirects to registration with the invite pre-applied
- Pending invites can be resent (new token, reset expiry) or revoked by the inviter
- A user cannot be invited to a workspace they're already a member of
- An email cannot have more than one pending invite to the same workspace

## Prohibitions (Don'ts)
- âŒ NEVER allow a Member-role user to send invites â€” only Owners and Admins. Enforce at the handler level, not just the endpoint auth policy.
- âŒ NEVER allow an Admin to invite someone as Owner â€” only Owners can assign Owner role. Role hierarchy: Owner > Admin > Member.
- âŒ NEVER send the invite token in plain text in logs â€” log only the invite ID and recipient email domain (e.g., `*@example.com`), never the full token.
- âŒ NEVER send an invite email synchronously in the handler â€” publish an `InviteCreatedEvent` and let the event handler send the email. If email fails, the invite still exists and can be resent.
- âŒ NEVER reuse an expired or declined token â€” always generate a fresh token on resend.
- âŒ NEVER allow accepting an invite after revocation â€” check status before processing acceptance, even if the token is technically valid.
- âŒ NEVER store the invite token in plain text â€” store a hashed version (SHA-256). The raw token only exists in the email link.

## Decision Tree
```
Send Invite Request
â”‚
â”œâ”€â”€ Validation
â”‚   â”œâ”€â”€ Email format invalid â†’ 422
â”‚   â”œâ”€â”€ Role not Member/Admin â†’ 422
â”‚   â”œâ”€â”€ Inviter not in workspace â†’ 403
â”‚   â”œâ”€â”€ Inviter is Member (not Admin/Owner) â†’ 403
â”‚   â”œâ”€â”€ Inviter is Admin but role=Owner â†’ 403 (escalation blocked)
â”‚   â””â”€â”€ Passes â†’ Continue
â”‚
â”œâ”€â”€ Target already a workspace member?
â”‚   â””â”€â”€ YES â†’ 409 Conflict ("already a member")
â”‚
â”œâ”€â”€ Pending invite already exists for this email + workspace?
â”‚   â””â”€â”€ YES â†’ 409 Conflict ("invite already pending â€” resend instead")
â”‚
â””â”€â”€ Create invite
    â”œâ”€â”€ Generate token (crypto-random, 64 bytes, base64url)
    â”œâ”€â”€ Store hashed token + metadata
    â””â”€â”€ Publish InviteCreatedEvent â†’ email handler sends link

---

Accept Invite (via token link)
â”‚
â”œâ”€â”€ Token lookup (by hash)
â”‚   â”œâ”€â”€ Not found â†’ 404
â”‚   â”œâ”€â”€ Expired â†’ 410 Gone ("invite expired â€” ask for a new one")
â”‚   â”œâ”€â”€ Already accepted â†’ 409 Conflict
â”‚   â”œâ”€â”€ Revoked â†’ 410 Gone ("invite was revoked")
â”‚   â””â”€â”€ Valid + Pending â†’ Continue
â”‚
â”œâ”€â”€ Email matches existing user?
â”‚   â”œâ”€â”€ YES â†’ Create WorkspaceMembership with invite's role
â”‚   â””â”€â”€ NO â†’ Return redirect URL to registration with invite token
â”‚
â””â”€â”€ Mark invite as Accepted, set AcceptedAt
```

## Domain Rules & Exceptions
| Rule | Applies When | Exception | Who Can Override |
|------|-------------|-----------|-----------------|
| Only Owner/Admin can invite | All invites | None | None |
| Admin cannot assign Owner role | Admin-sent invites | Owner-sent invites can assign any role | None |
| One pending invite per email per workspace | Always | Resend replaces the old token | N/A |
| Token expires after 7 days | All invites | None â€” resend to reset [NEEDS CLARIFICATION: Should Owners be able to configure expiry per workspace? e.g., 1â€“30 days?] | N/A |
| Max 50 pending invites per workspace | All workspaces | None | None |

## Escalation & Guardrails
- ğŸ›‘ **Fail if**: Inviter lacks permission, target already a member, invite already pending, token invalid/expired/revoked
- â¸ï¸ **Queue for review if**: N/A for this feature
- ğŸ”„ **Retry with backoff if**: Email delivery fails â€” the event handler retries 3 times with exponential backoff, then marks the invite as `EmailFailed` (invite remains valid, can be resent manually)
- ğŸ”” **Alert if**: Email failure rate exceeds 20% in a 10-minute window (likely provider issue)

## Data Model
- New entity: `WorkspaceInvite`
  - Properties: `Id` (Guid), `WorkspaceId` (FK), `InviterUserId` (FK), `Email` (string, normalized lowercase), `Role` (enum: Member, Admin), `TokenHash` (string, SHA-256 of raw token), `Status` (enum: Pending, Accepted, Declined, Revoked, Expired), `CreatedAt`, `ExpiresAt`, `AcceptedAt` (nullable), `AcceptedByUserId` (nullable FK)
  - Unique constraint: (`WorkspaceId`, `Email`) WHERE `Status = Pending` â€” filtered unique index
- New domain event: `InviteCreatedEvent` â€” triggers email sending
- New domain event: `InviteAcceptedEvent` â€” triggers welcome/onboarding flow
- No modifications to existing entities (WorkspaceMembership is created on accept, which is existing behavior via `AddMemberHandler`)

## API Contract

### Send Invite
- Route: `POST /api/workspaces/{workspaceId}/invites`
- Auth: Bearer token, must be Owner or Admin of the workspace
- Request body:
  - `email` (string, required, valid email format)
  - `role` (string, required, one of: `member`, `admin`)
- Success: `201 Created` â€” returns inviteId (guid), email (string), role (string), expiresAt (datetime)
- Errors: `403` (not authorized), `409` (already member or invite pending), `422` (validation)

### Accept Invite
- Route: `POST /api/invites/accept`
- Auth: Optional (may be unauthenticated if new user)
- Request body:
  - `token` (string, required) â€” the raw token from the email link
- Success: `200 OK` â€” returns workspaceId, workspaceName, role, memberships details
- Success (new user): `200 OK` â€” returns redirectUrl to registration with invite context
- Errors: `404` (token not found), `410` (expired/revoked), `409` (already accepted)

### Decline Invite
- Route: `POST /api/invites/decline`
- Auth: Optional
- Request body:
  - `token` (string, required)
- Success: `200 OK`
- Errors: same as accept

### Resend Invite
- Route: `POST /api/workspaces/{workspaceId}/invites/{inviteId}/resend`
- Auth: Bearer token, must be Owner or Admin
- Success: `200 OK` â€” returns new expiresAt
- Errors: `403`, `404`, `409` (invite not in Pending status)

### Revoke Invite
- Route: `DELETE /api/workspaces/{workspaceId}/invites/{inviteId}`
- Auth: Bearer token, must be Owner or Admin
- Success: `204 No Content`
- Errors: `403`, `404`, `409` (invite not in Pending status)

### List Pending Invites
- Route: `GET /api/workspaces/{workspaceId}/invites`
- Auth: Bearer token, must be Owner or Admin
- Success: `200 OK` â€” returns array of { inviteId, email, role, status, createdAt, expiresAt }

## Acceptance Criteria

### Happy Path
- [ ] Given an Owner, when they invite user@example.com as Admin, then an invite is created with a hashed token and an `InviteCreatedEvent` is published
- [ ] Given a valid pending invite token, when an existing user accepts, then a WorkspaceMembership is created with the invite's role and the invite is marked Accepted
- [ ] Given a valid token for a non-existing user, when they accept, then a redirect URL to registration is returned with the invite context
- [ ] Given a pending invite, when the inviter resends, then a new token is generated, the old hash is replaced, and ExpiresAt resets to 7 days from now

### Negative / Prohibition Tests
- [ ] Given a Member-role user, when they attempt to send an invite, then 403 is returned â€” even if the endpoint auth allows workspace members
- [ ] Given an Admin, when they try to invite someone as Owner, then 403 is returned with a clear message about role hierarchy
- [ ] Given any invite operation, then logs never contain the raw token â€” only invite ID and email domain
- [ ] Given invite creation, then no email is sent synchronously â€” only a domain event is published
- [ ] Given a revoked invite, when the recipient tries to accept with the original token, then 410 is returned
- [ ] Given an expired invite, when accepted, then 410 is returned â€” even though the token hashes correctly

### Edge Cases
- [ ] Given user@example.com is already a workspace member, when invited again, then 409 is returned
- [ ] Given a pending invite exists for user@example.com, when invited again to the same workspace, then 409 is returned with guidance to resend
- [ ] Given a workspace with 50 pending invites, when a 51st invite is attempted, then it is rejected
- [ ] Given an invite that was declined, when the same email is invited again, then a new invite is created (declined doesn't block re-invite)

### Integration / Resilience
- [ ] Given the email service is unavailable, when an invite is created, then the invite is still persisted and the event handler retries email delivery
- [ ] Given email delivery fails 3 times, then the invite status is set to `EmailFailed` and can be resent manually
- [ ] Given the email failure rate exceeds 20% in 10 minutes, then an ops alert is triggered

## Files to Create / Modify (Implementation Plan)
Based on reference patterns in `src/Features/Workspaces/AddWorkspace/` and `src/Features/Auth/ResetPassword/`:
- Create: `src/Features/Workspaces/InviteMember/SendInviteCommand.cs` â€” command record
- Create: `src/Features/Workspaces/InviteMember/SendInviteHandler.cs` â€” main handler: permission check, dedup, token gen, persist, publish event
- Create: `src/Features/Workspaces/InviteMember/SendInviteValidator.cs` â€” email format, role enum
- Create: `src/Features/Workspaces/InviteMember/SendInviteEndpoint.cs` â€” POST mapping
- Create: `src/Features/Workspaces/InviteMember/AcceptInviteCommand.cs` â€” command with raw token
- Create: `src/Features/Workspaces/InviteMember/AcceptInviteHandler.cs` â€” token lookup, status checks, membership creation or redirect
- Create: `src/Features/Workspaces/InviteMember/AcceptInviteEndpoint.cs` â€” POST mapping (no auth required)
- Create: `src/Features/Workspaces/InviteMember/DeclineInviteCommand.cs` + handler + endpoint
- Create: `src/Features/Workspaces/InviteMember/ResendInviteCommand.cs` + handler + endpoint
- Create: `src/Features/Workspaces/InviteMember/RevokeInviteCommand.cs` + handler + endpoint
- Create: `src/Features/Workspaces/InviteMember/ListInvitesQuery.cs` + handler + endpoint
- Create: `src/Features/Workspaces/Domain/WorkspaceInvite.cs` â€” entity
- Create: `src/Features/Workspaces/Domain/InviteStatus.cs` â€” enum
- Create: `src/Features/Workspaces/Events/InviteCreatedEvent.cs` â€” domain event
- Create: `src/Features/Workspaces/Events/InviteCreatedEventHandler.cs` â€” sends email via `IEmailService`
- Create: `src/Features/Workspaces/Events/InviteAcceptedEvent.cs` â€” domain event for downstream
- Modify: `src/Features/Workspaces/WorkspaceModule.cs` â€” register all handlers, validators, event handlers
- Modify: `src/Infrastructure/Persistence/AppDbContext.cs` â€” add `DbSet<WorkspaceInvite>`, configure filtered unique index
- Create: `tests/Features/Workspaces/InviteMember/SendInviteHandlerTests.cs`
- Create: `tests/Features/Workspaces/InviteMember/AcceptInviteHandlerTests.cs`
- Create: EF Core migration for `WorkspaceInvites` table with filtered unique index

## Observability
- Log (Info): Invite sent (inviteId, workspaceId, role, email domain only â€” e.g., `*@example.com`)
- Log (Info): Invite accepted (inviteId, workspaceId, isExistingUser)
- Log (Info): Invite declined/revoked (inviteId)
- Log (Warning): Invite email delivery failed (inviteId, attempt number)
- Log (Warning): Expired/revoked token acceptance attempted (inviteId)
- Metrics: `workspace_invites_total` (counter, labels: action=sent|accepted|declined|revoked|expired), `invite_email_failures_total` (counter)
- Never log: Raw invite token, full email address in structured logs (use domain only)

## Key Decisions Made
| Decision | Options Considered | Chosen | Rationale |
|----------|-------------------|--------|-----------|
| Token storage | A) Plain text B) Hashed (SHA-256) C) Encrypted | B) Hashed | Same pattern as password reset tokens; token only needs to be verified, not retrieved |
| Email delivery | A) Synchronous in handler B) Domain event + async handler C) Background job | B) Domain event | Matches existing pattern in `ResetPasswordHandler`; invite persists even if email fails |
| Duplicate handling | A) Silently ignore B) 409 Conflict C) Auto-resend | B) 409 Conflict | Explicit feedback helps admin know the invite exists; they can resend deliberately |
| Accept endpoint auth | A) Require login B) Allow unauthenticated C) Optional | C) Optional | New users won't be logged in; existing users may or may not be |
| Expiry handling | A) Background job expires old invites B) Check on access C) Both | B) Check on access | Simpler; no scheduler needed. Status field updated lazily when token is used. |

## Open Questions
_Broader strategic questions needing input from other teams. Tactical gaps are marked inline as `[NEEDS CLARIFICATION]` where they occur._
- Should declined invites be visible to workspace admins, or filtered out of the list? Needs UX decision.
- Should there be a cooldown before re-inviting after a decline (e.g., 24h)? Needs product input.
