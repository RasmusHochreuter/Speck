# Feature: Product Rating
> Specification generated by /plan-feature on 2026-02-13
> âš ï¸ This is a planning document. No implementation code has been written.
> **Complexity: Simple** â€” single entity, one endpoint, minimal branching.

## Implementation Instructions
This specification is context for the implementing agent. Read and internalize it fully before writing any code.

**IMPORTANT â€” Do NOT:**
- Add comments referencing this spec (no `// See spec: ...`, no `// Don't #3`)
- Structure code around spec sections â€” structure it around clean domain logic
- Embed spec traceability IDs in code, comments, variable names, or test names
- Add comments explaining "why" when the code is self-documenting

**DO:**
- Write clean, idiomatic C# that follows the reference implementation patterns
- Let the constraints from this spec guide your decisions silently â€” they should be invisible in the final code
- Name things after domain concepts, not spec concepts
- Write tests that verify behavior, named after what they verify (not after spec requirement IDs)

## Overview
Allow authenticated customers to rate products on a 1â€“5 star scale with an optional text review. Each customer can rate a product once; submitting again updates their existing rating.

## Scope
### In Scope
- Submit a star rating (1â€“5) with optional review text for a product
- Update an existing rating (upsert semantics)
- Recalculate and cache the product's average rating on write
- Return the current user's rating when viewing a product

### Out of Scope
- Review moderation / admin approval workflow
- Reporting or flagging inappropriate reviews
- Sorting or filtering reviews (that's a read-side concern, separate feature)
- Rating images or uploads

### Deferred
- "Was this review helpful?" voting
- Verified purchase badge

## Reference Implementation
- Reference: `src/Features/Products/GetProduct/GetProductHandler.cs`
- Follow the same: MediatR command/handler, FluentValidation, repository usage, test structure

## Codebase Context
- Architecture: Vertical Slices within Clean Architecture
- ORM: EF Core 8 with repository pattern (`IProductRepository`)
- Mediator: MediatR
- Test framework: xUnit + NSubstitute + FluentAssertions
- Validation: FluentValidation
- DI registration: Via `AddProductModule()` extension in `src/Features/Products/ProductModule.cs`
- Error handling: `Result<T>` pattern â€” never throws for business rule violations

## Requirements
- Authenticated customers can submit a 1â€“5 star rating for any product
- An optional review text (max 2000 chars) can accompany the rating
- If the customer has already rated the product, the new rating replaces the old one (upsert)
- The product's average rating and total count are recalculated on each write
- The customer's own rating is included when fetching product details

## Prohibitions (Don'ts)
- âŒ NEVER allow a rating outside 1â€“5 â€” reject at validation, not at the database constraint level
- âŒ NEVER recalculate the average by scanning all ratings on every read â€” compute on write and cache on the `Product` entity
- âŒ NEVER allow a customer to rate a product they have never been able to view (i.e., respect product visibility rules if they exist)
- âŒ NEVER return another customer's identity in rating responses â€” ratings are anonymous to other users (only the submitter sees "your rating")
- âŒ NEVER store raw HTML in review text â€” sanitize or reject markup

## Decision Tree
```
Rate Product Request
â”‚
â”œâ”€â”€ Validation
â”‚   â”œâ”€â”€ Product not found â†’ 404 NotFound
â”‚   â”œâ”€â”€ Stars not 1â€“5 â†’ 422 Validation error
â”‚   â”œâ”€â”€ Review text > 2000 chars â†’ 422 Validation error
â”‚   â””â”€â”€ Passes â†’ Continue
â”‚
â”œâ”€â”€ Existing rating by this customer for this product?
â”‚   â”œâ”€â”€ YES â†’ Update stars + review text + timestamp
â”‚   â””â”€â”€ NO â†’ Create new ProductRating
â”‚
â””â”€â”€ Recalculate product average
    â””â”€â”€ Update Product.AverageRating and Product.RatingCount
```

## Domain Rules & Exceptions
| Rule | Applies When | Exception | Who Can Override |
|------|-------------|-----------|-----------------|
| One rating per customer per product | Always | None â€” upsert replaces | N/A |
| Review text max 2000 chars | When text provided | None | None |
| Average recalculated on write | Every rating submit | None | None |

## Escalation & Guardrails
- ðŸ›‘ **Fail if**: Product not found, validation fails, user not authenticated
- ðŸ”„ **Retry**: Not needed â€” purely internal DB operation, no external calls
- ðŸ”” **Alert if**: N/A for this simple feature

## Data Model
- New entity: `ProductRating`
  - Properties: `Id`, `ProductId` (FK), `CustomerId` (FK), `Stars` (int, 1â€“5), `ReviewText` (string, nullable, max 2000), `CreatedAt`, `UpdatedAt`
  - Unique constraint: (`ProductId`, `CustomerId`) â€” enforces one rating per customer per product
- Modified: `Product` entity â€” add `AverageRating` (decimal, nullable), `RatingCount` (int, default 0)
- Migration needed: Yes â€” new `ProductRatings` table + two columns on `Products`

## API Contract
- Route: `PUT /api/products/{productId}/rating`
- Auth: Bearer token, must be authenticated customer
- Request body fields:
  - `stars` (int, required, 1â€“5) â€” the rating value
  - `reviewText` (string, optional, max 2000 chars) â€” free-text review
- Success response:
  - `200 OK` â€” returns stars (int), reviewText (string|null), updatedAt (datetime), productAverageRating (decimal), productRatingCount (int)
- Error responses:
  - `401 Unauthorized` â€” not authenticated
  - `404 NotFound` â€” product doesn't exist
  - `422 UnprocessableEntity` â€” validation failure (stars out of range, text too long)

## Acceptance Criteria

### Happy Path
- [ ] Given an authenticated customer and a valid product, when they submit a rating of 4 stars, then a ProductRating is created and the product's average is updated
- [ ] Given a customer who already rated a product 3 stars, when they submit 5 stars, then the existing rating is updated (not duplicated) and the average recalculates

### Negative / Prohibition Tests
- [ ] Given a rating of 0 or 6, then validation rejects it before it reaches the handler
- [ ] Given review text of 2001 characters, then validation rejects it
- [ ] Given an unauthenticated request, then 401 is returned

### Edge Cases
- [ ] Given the first-ever rating on a product, then AverageRating equals the submitted stars and RatingCount is 1
- [ ] Given a customer updates their rating, then RatingCount stays the same (not incremented)
- [ ] Given a product with 1000 existing ratings, then the average recalculation is still correct after an upsert

## Files to Create / Modify (Implementation Plan)
Based on the reference implementation pattern in `src/Features/Products/GetProduct/`:
- Create: `src/Features/Products/RateProduct/RateProductCommand.cs` â€” command record with ProductId, Stars, ReviewText
- Create: `src/Features/Products/RateProduct/RateProductHandler.cs` â€” upsert logic + average recalculation
- Create: `src/Features/Products/RateProduct/RateProductValidator.cs` â€” FluentValidation for stars range and text length
- Create: `src/Features/Products/RateProduct/RateProductEndpoint.cs` â€” PUT endpoint mapping
- Create: `src/Features/Products/Domain/ProductRating.cs` â€” new entity
- Modify: `src/Features/Products/Domain/Product.cs` â€” add AverageRating and RatingCount properties
- Modify: `src/Features/Products/ProductModule.cs` â€” register handler and validator
- Modify: `src/Infrastructure/Persistence/AppDbContext.cs` â€” add DbSet<ProductRating>, configure unique index
- Create: `tests/Features/Products/RateProduct/RateProductHandlerTests.cs` â€” tests covering all acceptance criteria
- Create: EF Core migration for new table + Product columns

## Observability
- Log (Info): Rating submitted (productId, customerId, stars, isUpdate)
- Metrics: `product_ratings_total` (counter, labels: stars)
- Never log: Customer email or auth tokens

## Key Decisions Made
| Decision | Options Considered | Chosen | Rationale |
|----------|-------------------|--------|-----------|
| Upsert vs reject duplicate | A) Upsert (replace) B) Reject with 409 | A) Upsert | Better UX â€” customers expect to change their mind |
| Average calculation | A) On write (denormalized) B) On read (query) C) Background job | A) On write | Reads vastly outnumber writes; avoid N+1 on product listing |
| HTTP method | A) POST B) PUT | B) PUT | Idempotent by nature â€” same customer + product = same resource |

## Open Questions
_Broader strategic questions needing input from other teams. Tactical gaps are marked inline as `[NEEDS CLARIFICATION]` where they occur._
- Should there be a minimum purchase or interaction requirement before rating? Needs product decision.
